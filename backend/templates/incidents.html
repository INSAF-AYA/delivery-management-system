{% extends 'base_dashboard.html' %}
{% load static %}

{% block title %}SwiftShip - Incidents{% endblock %}

{% block nav_incidents %}active{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/incidents.css' %}">
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/incidents.js' %}"></script>
{% endblock %}

{% block content %}
<h1 class="page-title"><i class="fas fa-exclamation-triangle"></i> Incidents</h1>

<!-- Incidents Table Section -->
<div class="table-section">
    <!-- Table Header with Search -->
    <div class="table-header">
        <div class="table-search">
            <div class="table-search-input">
                <i class="fas fa-search"></i>
                <input type="text" id="incidentSearch" placeholder="Search incidents...">
            </div>
            <button class="filter-btn" id="filterBtn">
                <i class="fas fa-filter"></i>
                Filter
            </button>
        </div>
        
        <div class="table-toolbar">
            <button class="toolbar-btn add" onclick="openAddModal()">
                <i class="fas fa-plus"></i>
                Report Incident
            </button>
        </div>

        
        <!-- Filter Panel Section -->
        <div id="filterPanel" style="display:none;margin-top:10px;" class="filter-panel">
            <label for="filterField" style="margin-right:8px;">Field:</label>
            <select id="filterField">
                <option value="all">All (ID / Type / Priority / Status)</option>
                <option value="id">Incident ID</option>
                <option value="type">Type</option>
                <option value="priority">Priority</option>
                <option value="status">Status</option>
            </select>
            <input type="text" id="filterValue" placeholder="Filter value" style="margin-left:8px;" />
            <button class="modal-btn" id="applyFilterBtn" style="margin-left:8px;">Apply</button>
            <button class="modal-btn" id="clearFilterBtn" style="margin-left:6px;">Clear</button>
        </div>
    </div>

    <!-- Data Table -->
    <div class="table-container">
        <table class="data-table" id="incidentsTable">
            <thead>
                <tr>
                    <th>Incident ID</th>
                    <th>Type</th>
                    <th>Description</th>
                    <th>Priority</th>
                    <th>Date</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="incidentsTableBody">
                {% for incident in incidents %}
                <tr data-id="{{ incident.id_incident }}" onclick="selectRow(this)">
                    <td>{{ incident.id_incident }}</td>
                    <td>{{ incident.get_incident_type_display }}</td>
                    <td>{{ incident.description|truncatewords:10 }}</td>
                    <td>
                        {% if incident.priority == 'critical' %}
                        <span class="badge danger">Critical</span>
                        {% elif incident.priority == 'high' %}
                        <span class="badge warning">High</span>
                        {% elif incident.priority == 'medium' %}
                        <span class="badge info">Medium</span>
                        {% else %}
                        <span class="badge">Low</span>
                        {% endif %}
                    </td>
                    <td>{{ incident.incident_date|date:"Y-m-d" }}</td>
                    <td>
                        {% if incident.status == 'resolved' %}
                        <span class="badge success">Resolved</span>
                        {% elif incident.status == 'in_progress' %}
                        <span class="badge info">In Progress</span>
                        {% elif incident.status == 'open' or incident.status == 'new' %}
                        <span class="badge warning">Open</span>
                        {% elif incident.status == 'closed' %}
                        <span class="badge">Closed</span>
                        {% else %}
                        <span class="badge">{{ incident.get_status_display }}</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="action-btns">
                            <button class="action-btn view" title="View Details" onclick="event.stopPropagation(); openViewModal('{{ incident.id_incident }}');">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn edit" title="Modify" onclick="event.stopPropagation(); openEditModal('{{ incident.id_incident }}');">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete" title="Delete" onclick="event.stopPropagation(); openDeleteModal('{{ incident.id_incident }}');">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" style="text-align:center;">No incidents found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block modals %}
<!-- Add Modal -->
<div class="modal" id="addModal">
    <div class="modal-window edit-modal">
        <div class="modal-header">
            <h3><i class="fas fa-plus"></i> Report Incident</h3>
            <button class="modal-close" onclick="closeModal('addModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form class="modal-form" id="addIncidentForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="addType">Incident Type</label>
                        <select id="addType">
                            <option value="delay">Delay</option>
                            <option value="damage">Damage</option>
                            <option value="loss">Package Loss</option>
                            <option value="technical">Technical Problem</option>
                            <option value="accident">Accident</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="addPriority">Priority</label>
                        <select id="addPriority">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                            <option value="critical">Critical</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="addDescription">Description</label>
                    <textarea id="addDescription" placeholder="Describe the incident..." rows="3"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="addDate">Date</label>
                        <input type="date" id="addDate">
                    </div>
                    <div class="form-group">
                        <label for="addStatus">Status</label>
                        <select id="addStatus">
                            <option value="new">New</option>
                            <option value="open">Open</option>
                            <option value="in_progress">In Progress</option>
                            <option value="resolved">Resolved</option>
                            <option value="closed">Closed</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="addCommentaire">Comments</label>
                    <textarea id="addCommentaire" placeholder="Additional comments..." rows="2"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="modal-btn cancel" onclick="closeModal('addModal')">Cancel</button>
            <button class="modal-btn primary" onclick="addIncident()">
                <i class="fas fa-plus"></i> Report
            </button>
        </div>
    </div>
</div>

<!-- View Modal -->
<div class="modal" id="viewModal">
    <div class="modal-window view-modal">
        <div class="modal-header">
            <h3><i class="fas fa-eye"></i> Incident Details</h3>
            <button class="modal-close" onclick="closeModal('viewModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div id="viewIncidentDetails" class="incident-details">
                <!-- Filled dynamically by JS -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="modal-btn cancel" onclick="closeModal('viewModal')">Close</button>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal" id="editModal">
    <div class="modal-window edit-modal">
        <div class="modal-header">
            <h3><i class="fas fa-edit"></i> Edit Incident</h3>
            <button class="modal-close" onclick="closeModal('editModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form class="modal-form" id="editIncidentForm">
                <input type="hidden" id="editIncidentId">
                <div class="form-row">
                    <div class="form-group">
                        <label for="editType">Incident Type</label>
                        <select id="editType">
                            <option value="delay">Delay</option>
                            <option value="damage">Damage</option>
                            <option value="loss">Package Loss</option>
                            <option value="technical">Technical Problem</option>
                            <option value="accident">Accident</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editPriority">Priority</label>
                        <select id="editPriority">
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                            <option value="critical">Critical</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="editDescription">Description</label>
                    <textarea id="editDescription" placeholder="Describe the incident..." rows="3"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editDate">Date</label>
                        <input type="date" id="editDate">
                    </div>
                    <div class="form-group">
                        <label for="editStatus">Status</label>
                        <select id="editStatus">
                            <option value="new">New</option>
                            <option value="open">Open</option>
                            <option value="in_progress">In Progress</option>
                            <option value="resolved">Resolved</option>
                            <option value="closed">Closed</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="editCommentaire">Comments</label>
                    <textarea id="editCommentaire" placeholder="Additional comments..." rows="2"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="modal-btn cancel" onclick="closeModal('editModal')">Cancel</button>
            <button class="modal-btn primary" onclick="saveIncidentChanges()">
                <i class="fas fa-save"></i> Save Changes
            </button>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal" id="deleteModal">
    <div class="modal-window delete-modal">
        <div class="modal-header">
            <h3><i class="fas fa-trash"></i> Delete Incident</h3>
            <button class="modal-close" onclick="closeModal('deleteModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="delete-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <p class="delete-message">Are you sure you want to delete this incident?</p>
            <p id="deleteIncidentInfo" style="font-weight:600;"></p>
            <p class="delete-warning">This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
            <button class="modal-btn cancel" onclick="closeModal('deleteModal')">Cancel</button>
            <button class="modal-btn danger" onclick="confirmDelete()">
                <i class="fas fa-trash"></i> Delete
            </button>
        </div>
    </div>
</div>
{% endblock %}
