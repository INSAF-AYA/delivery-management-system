{% extends 'base_dashboard.html' %}
{% load static %}

{% block title %}SwiftShip - Drivers{% endblock %}

{% block nav_drivers %}active{% endblock %}

{% block content %}
<h1 class="page-title"><i class="fas fa-id-card"></i> Drivers</h1>

<div class="table-section">
    <div class="table-header">
        <div class="table-search">
            <div class="table-search-input">
                <i class="fas fa-search"></i>
                <input type="text" id="driverSearch" placeholder="Search drivers...">
            </div>
            <button class="filter-btn" id="filterBtn">
                <i class="fas fa-filter"></i>
                Filter
            </button>
        </div>
        
        <div class="table-toolbar">
            <button class="toolbar-btn add" onclick="openAddModal()">
                <i class="fas fa-plus"></i>
                Add Driver
            </button>
        </div> 
        
        <!-- Compact filter panel (hidden by default) -->
        <div id="filterPanel" style="display:none;margin-top:10px;" class="filter-panel">
            <label for="filterField" style="margin-right:8px;">Field:</label>
            <select id="filterField">
                <option value="all">All (id / name / email / phone / license / vehicle / status)</option>
                <option value="id">Driver ID</option>
                <option value="name">Name</option>
                <option value="email">Email</option>
                <option value="phone">Phone</option>
                <option value="license">License</option>
                <option value="vehicle">Vehicle</option>
                <option value="status">Status</option>
            </select>
            <input type="text" id="filterValue" placeholder="Filter value" style="margin-left:8px;" />
            <button class="modal-btn" id="applyFilterBtn" style="margin-left:8px;">Apply</button>
            <button class="modal-btn" id="clearFilterBtn" style="margin-left:6px;">Clear</button>
        </div>
    </div>

    <div class="table-container">
        <table class="data-table" id="driversTable">
            <thead>
                <tr>
                    <th>Driver ID</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>License</th>
                    <th>Vehicle</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="driversTableBody">
                {% for driver in drivers %}
                <tr data-id="{{ driver.id_chauffeur }}" onclick="selectRow(this)">
                    <td>{{ driver.id_chauffeur }}</td>
                    <td>{{ driver.nom }} {{ driver.prenom }}</td>
                    <td>{{ driver.email|default:"-" }}</td>
                    <td>{{ driver.telephone|default:"-" }}</td>
                    <td>{{ driver.numero_permis }}</td>
                    <td>{% if driver.vehicule %}{{ driver.vehicule.immatriculation }}{% else %}-{% endif %}</td>
                    <td><span class="status-badge status-{{ driver.statut }}">{{ driver.get_statut_display }}</span></td>
                    <td>
                        <div class="action-btns">
                            <button class="action-btn view" title="View" onclick="event.stopPropagation(); openViewModal('{{ driver.id_chauffeur }}');">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn edit" title="Edit" onclick="event.stopPropagation(); openEditModal('{{ driver.id_chauffeur }}');">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete" title="Delete" onclick="event.stopPropagation(); openDeleteModal('{{ driver.id_chauffeur }}');">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="8" style="text-align:center;">No drivers found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block modals %}
<!-- Add Modal -->
<div class="modal" id="addModal">
    <div class="modal-window edit-modal">
        <div class="modal-header">
            <h3><i class="fas fa-plus"></i> Add Driver</h3>
            <button class="modal-close" onclick="closeModal('addModal')"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <form class="modal-form" id="addDriverForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>First Name</label>
                        <input type="text" id="addPrenom" placeholder="First name" required>
                    </div>
                    <div class="form-group">
                        <label>Last Name</label>
                        <input type="text" id="addNom" placeholder="Last name" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="addEmail" placeholder="Email address">
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" id="addTelephone" placeholder="Phone number">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>License Number</label>
                        <input type="text" id="addPermis" placeholder="License number" required>
                    </div>
                    <div class="form-group">
                        <label>Vehicle</label>
                        <select id="addVehicule">
                            <option value="">-- None --</option>
                            {% for v in vehicles %}
                            <option value="{{ v.id_vehicule }}">{{ v.immatriculation }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="addStatut">
                        <option value="actif">Active</option>
                        <option value="inactif">Inactive</option>
                        <option value="suspendu">Suspended</option>
                        <option value="en_conge">On Leave</option>
                    </select>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="modal-btn cancel" onclick="closeModal('addModal')">Cancel</button>
            <button class="modal-btn primary" onclick="addDriver()"><i class="fas fa-plus"></i> Add</button>
        </div>
    </div>
</div>

<!-- View Modal -->
<div class="modal" id="viewModal">
    <div class="modal-window view-modal">
        <div class="modal-header">
            <h3><i class="fas fa-eye"></i> Driver Details</h3>
            <button class="modal-close" onclick="closeModal('viewModal')"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <div id="viewDriverDetails"></div>
            <div id="viewDriverPassword" style="display:none;margin-top:12px;padding:10px;background:#f0f9ff;border-radius:6px;"></div>
        </div>
        <div class="modal-footer">
                             {# Show to Django staff OR to session-based Agent admins (logged_in_role from context processor) #}
                        {% if user.is_staff or logged_in_role == 'Admin' or logged_in_role == 'Agent' %}
                        <button class="btn btn-warning" id="viewGenerateDriverPasswordBtn" onclick="generateDriverPasswordForCurrentView()">
                            <i class="fas fa-key"></i> Generate Password
                        </button>
                        {% endif %}
            <button class="modal-btn cancel" onclick="closeModal('viewModal')">Close</button>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal" id="editModal">
    <div class="modal-window edit-modal">
        <div class="modal-header">
            <h3><i class="fas fa-edit"></i> Edit Driver</h3>
            <button class="modal-close" onclick="closeModal('editModal')"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <form class="modal-form" id="editDriverForm">
                <input type="hidden" id="editDriverId">
                <div class="form-row">
                    <div class="form-group">
                        <label>First Name</label>
                        <input type="text" id="editPrenom" placeholder="First name" required>
                    </div>
                    <div class="form-group">
                        <label>Last Name</label>
                        <input type="text" id="editNom" placeholder="Last name" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="editEmail" placeholder="Email address">
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" id="editTelephone" placeholder="Phone number">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>License Number</label>
                        <input type="text" id="editPermis" placeholder="License number" required>
                    </div>
                    <div class="form-group">
                        <label>Vehicle</label>
                        <select id="editVehicule">
                            <option value="">-- None --</option>
                            {% for v in vehicles %}
                            <option value="{{ v.id_vehicule }}">{{ v.immatriculation }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="editStatut">
                        <option value="actif">Active</option>
                        <option value="inactif">Inactive</option>
                        <option value="suspendu">Suspended</option>
                        <option value="en_conge">On Leave</option>
                    </select>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="modal-btn cancel" onclick="closeModal('editModal')">Cancel</button>
            <button class="modal-btn primary" onclick="saveDriver()"><i class="fas fa-save"></i> Save</button>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal" id="deleteModal">
    <div class="modal-window delete-modal">
        <div class="modal-header">
            <h3><i class="fas fa-trash"></i> Delete Driver</h3>
            <button class="modal-close" onclick="closeModal('deleteModal')"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <div class="delete-icon"><i class="fas fa-exclamation-triangle"></i></div>
            <p class="delete-message">Are you sure you want to delete this driver?</p>
            <p id="deleteDriverInfo" style="font-weight:600;"></p>
            <p class="delete-warning">This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
            <button class="modal-btn cancel" onclick="closeModal('deleteModal')">Cancel</button>
            <button class="modal-btn danger" onclick="confirmDelete()"><i class="fas fa-trash"></i> Delete</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentDriverId = null;
let selectedRow = null;

function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
           document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1] || '';
}

function selectRow(row) {
    if (selectedRow) selectedRow.classList.remove('selected');
    selectedRow = row;
    row.classList.add('selected');
}

function openAddModal() {
    document.getElementById('addDriverForm').reset();
    document.getElementById('addModal').classList.add('active');
}

function openViewModal(driverId) {
    currentDriverId = driverId;
    fetch(`/dashboard/drivers/${driverId}/json/`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const d = data.driver;
                const statusLabels = {
                    'actif': 'Active',
                    'inactif': 'Inactive',
                    'suspendu': 'Suspended',
                    'en_conge': 'On Leave'
                };
                document.getElementById('viewDriverDetails').innerHTML = `
                    <div class="detail-row"><strong>Driver ID:</strong> ${d.id_chauffeur}</div>
                    <div class="detail-row"><strong>Name:</strong> ${d.nom} ${d.prenom}</div>
                    <div class="detail-row"><strong>Email:</strong> ${d.email || '-'}</div>
                    <div class="detail-row"><strong>Phone:</strong> ${d.telephone || '-'}</div>
                    <div class="detail-row"><strong>License:</strong> ${d.numero_permis}</div>
                    <div class="detail-row"><strong>Vehicle:</strong> ${d.vehicule || '-'}</div>
                    <div class="detail-row"><strong>Status:</strong> ${statusLabels[d.statut] || d.statut}</div>
                `;
                document.getElementById('viewDriverPassword').style.display = 'none';
                document.getElementById('viewModal').classList.add('active');
            }
        });
}

function openEditModal(driverId) {
    currentDriverId = driverId;
    fetch(`/dashboard/drivers/${driverId}/json/`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const d = data.driver;
                document.getElementById('editDriverId').value = d.id_chauffeur;
                document.getElementById('editPrenom').value = d.prenom;
                document.getElementById('editNom').value = d.nom;
                document.getElementById('editEmail').value = d.email || '';
                document.getElementById('editTelephone').value = d.telephone || '';
                document.getElementById('editPermis').value = d.numero_permis;
                document.getElementById('editVehicule').value = d.vehicule_id || '';
                document.getElementById('editStatut').value = d.statut;
                document.getElementById('editModal').classList.add('active');
            }
        });
}

function openDeleteModal(driverId) {
    currentDriverId = driverId;
    document.getElementById('deleteDriverInfo').textContent = `Driver ID: ${driverId}`;
    document.getElementById('deleteModal').classList.add('active');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
}

function addDriver() {
    const data = {
        prenom: document.getElementById('addPrenom').value,
        nom: document.getElementById('addNom').value,
        email: document.getElementById('addEmail').value,
        telephone: document.getElementById('addTelephone').value,
        numero_permis: document.getElementById('addPermis').value,
        vehicule_id: document.getElementById('addVehicule').value,
        statut: document.getElementById('addStatut').value
    };
    fetch('/dashboard/drivers/add/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
        body: JSON.stringify(data)
    }).then(r => r.json()).then(data => {
        if (data.success) { closeModal('addModal'); location.reload(); }
        else alert('Error: ' + (data.error || 'Failed'));
    });
}

function saveDriver() {
    const data = {
        prenom: document.getElementById('editPrenom').value,
        nom: document.getElementById('editNom').value,
        email: document.getElementById('editEmail').value,
        telephone: document.getElementById('editTelephone').value,
        numero_permis: document.getElementById('editPermis').value,
        vehicule_id: document.getElementById('editVehicule').value,
        statut: document.getElementById('editStatut').value
    };
    fetch(`/dashboard/drivers/${currentDriverId}/edit/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
        body: JSON.stringify(data)
    }).then(r => r.json()).then(data => {
        if (data.success) { closeModal('editModal'); location.reload(); }
        else alert('Error: ' + (data.error || 'Failed'));
    });
}

function confirmDelete() {
    fetch(`/dashboard/drivers/${currentDriverId}/delete/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': getCSRFToken() }
    }).then(r => r.json()).then(data => {
        if (data.success) { closeModal('deleteModal'); location.reload(); }
        else alert('Error: ' + (data.error || 'Failed'));
    });
}

// Initialize search + filter controls
document.addEventListener('DOMContentLoaded', function () {
    const searchInput = document.getElementById('driverSearch');
    if (searchInput) {
        searchInput.addEventListener('input', e => {
            filterDrivers('all', e.target.value);
        });
    }

    const filterBtn = document.getElementById('filterBtn');
    if (filterBtn) filterBtn.addEventListener('click', () => toggleFilterPanel());

    const applyFilterBtn = document.getElementById('applyFilterBtn');
    if (applyFilterBtn) applyFilterBtn.addEventListener('click', () => applyFilter());
    const clearFilterBtn = document.getElementById('clearFilterBtn');
    if (clearFilterBtn) clearFilterBtn.addEventListener('click', () => clearFilter());
});

function filterDrivers(fieldOrTerm, maybeTerm) {
    // Signature: filterDrivers(term) or filterDrivers(field, term)
    let field = 'all';
    let term = '';
    if (typeof maybeTerm === 'undefined') {
        term = (fieldOrTerm || '').toString().toLowerCase();
    } else {
        field = (fieldOrTerm || 'all').toString();
        term = (maybeTerm || '').toString().toLowerCase();
    }

    const rows = document.querySelectorAll('#driversTableBody tr');
    const map = {
        id: 0,
        name: 1,
        email: 2,
        phone: 3,
        license: 4,
        vehicle: 5,
        status: 6
    };

    rows.forEach(row => {
        if (!term) { row.style.display = ''; return; }

        if (field === 'all') {
            const id = (row.cells[0]?.textContent || '').toLowerCase();
            const name = (row.cells[1]?.textContent || '').toLowerCase();
            const email = (row.cells[2]?.textContent || '').toLowerCase();
            const phone = (row.cells[3]?.textContent || '').toLowerCase();
            const license = (row.cells[4]?.textContent || '').toLowerCase();
            const vehicle = (row.cells[5]?.textContent || '').toLowerCase();
            const status = (row.cells[6]?.textContent || '').toLowerCase();
            const hay = `${id} ${name} ${email} ${phone} ${license} ${vehicle} ${status}`;
            row.style.display = hay.includes(term) ? '' : 'none';
        } else {
            const idx = map[field];
            const value = (row.cells[idx]?.textContent || '').toLowerCase();
            row.style.display = value.includes(term) ? '' : 'none';
        }
    });
}

function toggleFilterPanel() {
    const panel = document.getElementById('filterPanel');
    if (!panel) return;
    panel.style.display = (panel.style.display === 'none' || panel.style.display === '') ? 'block' : 'none';
}

function applyFilter() {
    const field = document.getElementById('filterField')?.value || 'all';
    const value = document.getElementById('filterValue')?.value || '';
    filterDrivers(field, value.trim());
}

function clearFilter() {
    const fieldEl = document.getElementById('filterField');
    const valEl = document.getElementById('filterValue');
    if (fieldEl) fieldEl.value = 'all';
    if (valEl) valEl.value = '';
    const searchInput = document.getElementById('driverSearch');
    if (searchInput) searchInput.value = '';
    filterDrivers('all', '');
}

// Generate driver password for current view (used by the Generate Password button)
function generateDriverPasswordForCurrentView() {
    const modal = document.getElementById('viewModal');
    if (!modal) return;
    const driverId = modal.dataset.driverId || currentDriverId;
    if (!driverId) { alert('Driver ID introuvable'); return; }
    const csrftoken = getCSRFToken();
    fetch(`/dashboard/drivers/${driverId}/reset_password/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken }
    }).then(r => r.json()).then(data => {
        if (data && data.success) {
            const passwordEl = document.getElementById('viewDriverPassword');
            if (passwordEl) {
                passwordEl.style.display = 'block';
                passwordEl.innerHTML = `<div class="detail-row"><strong>New password:</strong> <code id="generatedDriverPassword">${data.password}</code> <button class="modal-btn" onclick="copyDriverGeneratedPassword()"><i class="fas fa-copy"></i> Copy</button></div>`;
            }
        } else {
            alert('Erreur lors de la génération du mot de passe');
        }
    }).catch(err => { console.error(err); alert('Erreur réseau'); });
}

// Robust copy for generated driver password (Clipboard API + fallback)
function copyDriverGeneratedPassword() {
    const el = document.getElementById('generatedDriverPassword');
    if (!el) return;
    const text = el.textContent || el.innerText || '';

    if (navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
        navigator.clipboard.writeText(text).then(() => {
            alert('Copié !');
        }).catch(err => {
            console.warn('navigator.clipboard.writeText failed', err);
            fallbackCopy(text);
        });
    } else {
        fallbackCopy(text);
    }

    function fallbackCopy(str) {
        try {
            const ta = document.createElement('textarea');
            ta.value = str;
            ta.style.position = 'fixed';
            ta.style.top = '0';
            ta.style.left = '0';
            ta.style.width = '1px';
            ta.style.height = '1px';
            ta.style.padding = '0';
            ta.style.border = 'none';
            ta.style.outline = 'none';
            ta.style.boxShadow = 'none';
            ta.style.background = 'transparent';
            document.body.appendChild(ta);
            ta.focus();
            ta.select();
            const ok = document.execCommand('copy');
            ta.remove();
            if (ok) alert('Copié !'); else alert('Impossible de copier');
        } catch (e) {
            console.error('fallback copy failed', e);
            alert('Impossible de copier');
        }
    }
}
</script>
{% endblock %}
