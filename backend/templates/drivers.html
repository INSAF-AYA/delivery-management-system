{% extends 'base_dashboard.html' %}
{% load static %}

{% block title %}Drivers — SwiftShip{% endblock %}

{% block content %}
<div class="page-content">
  <h1 class="page-title"><i class="fas fa-id-card"></i> Drivers</h1>

  <div class="table-header">
    <div class="table-search">
      <div class="table-search-input">
        <i class="fas fa-search"></i>
        <input type="text" id="driverSearch" placeholder="Search by name...">
      </div>
      <button class="filter-btn" id="filterBtn">
        <i class="fas fa-filter"></i>
        Filter
      </button>
    </div>

    <div class="table-toolbar">
      <button class="toolbar-btn add" onclick="openModal('addDriverModal')">
        <i class="fas fa-plus"></i> Add Driver
      </button>
    </div>
  </div>

  <div id="filterPanel" style="display:none;margin-top:10px;" class="filter-panel">
    <label for="filterField" style="margin-right:8px;">Field:</label>
    <select id="filterField">
      <option value="all">All (id / nom / prenom / email / telephone / permis / status)</option>
      <option value="id">ID</option>
      <option value="nom">Nom</option>
      <option value="prenom">Prénom</option>
      <option value="email">Email</option>
      <option value="telephone">Téléphone</option>
      <option value="permis">Permis</option>
      <option value="status">Status</option>
    </select>
    <input type="text" id="filterValue" placeholder="Filter value" style="margin-left:8px;" />
    <button class="modal-btn" id="applyFilterBtn" style="margin-left:8px;">Apply</button>
    <button class="modal-btn" id="clearFilterBtn" style="margin-left:6px;">Clear</button>
  </div>

  <div class="table-container">
    <table class="data-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Nom</th>
          <th>Prénom</th>
          <th>Email</th>
          <th>Téléphone</th>
          <th>Permis</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="driversTableBody">
        {% for driver in drivers %}
        <tr data-id="{{ driver.id_chauffeur }}" onclick="selectRow(this)">
          <td>{{ driver.id_chauffeur }}</td>
          <td>{{ driver.nom }}</td>
          <td>{{ driver.prenom }}</td>
          <td>{{ driver.email|default:"-" }}</td>
          <td>{{ driver.telephone|default:"-" }}</td>
          <td>{{ driver.numero_permis }}</td>
          <td>{{ driver.get_statut_display }}</td>
          <td>
            <div class="action-btns">
              <button class="action-btn view" title="View" onclick="openViewModal('{{ driver.id_chauffeur }}')">
                <i class="fas fa-eye"></i>
              </button>

                <button class="action-btn edit" title="Edit" onclick="openEditModal('{{ driver.id_chauffeur }}')">
                  <i class="fas fa-edit"></i>
                </button>

                <button class="action-btn delete" title="Delete" onclick="openDeleteModal('{{ driver.id_chauffeur }}')">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="8" style="text-align:center;">No drivers found</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>

  <!-- ================= ADD MODAL ================= -->
  <div id="addDriverModal" class="modal">
    <div class="modal-content">
      <h2>Add Driver</h2>
      <form id="addDriverForm" method="post" action="{% url 'dashboard_add_driver' %}">
        {% csrf_token %}
        <input name="nom" placeholder="Nom" required>
        <input name="prenom" placeholder="Prénom" required>
        <input name="email" type="email" placeholder="Email">
        <input name="telephone" placeholder="Téléphone">
        <input name="numero_permis" placeholder="Numéro de permis" required>

        <select name="statut">
          <option value="actif">Actif</option>
          <option value="inactif">Inactif</option>
          <option value="suspendu">Suspendu</option>
          <option value="en_conge">En congé</option>
        </select>

        <div class="modal-footer">
          <button type="button" onclick="closeModal('addDriverModal')">Cancel</button>
          <button type="submit" class="primary">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ================= VIEW MODAL ================= -->
  <div id="viewDriverModal" class="modal">
    <div class="modal-content">
      <h2>Driver Details</h2>
      <div id="viewDriverDetails"><!-- filled by JS --></div>

      <div id="viewDriverPassword" style="display:none;margin-top:12px;"></div>

      <div class="modal-footer">
        {% if user.is_staff %}
        <button class="modal-btn" id="viewGenerateDriverPasswordBtn" onclick="generateDriverPasswordForCurrentView()">
          <i class="fas fa-key"></i> Générer mot de passe
        </button>
        {% endif %}
        <button onclick="closeModal('viewDriverModal')">Close</button>
      </div>
    </div>
  </div>

  <!-- ================= EDIT MODAL ================= -->
  <div id="editDriverModal" class="modal">
    <div class="modal-content">
      <h2>Edit Driver</h2>
      <form id="editDriverForm" method="post" action="{% url 'dashboard_drivers' %}">
        {% csrf_token %}
        <input type="hidden" name="driver_id" id="editDriverId">
        <input type="hidden" name="action" value="edit">

        <input name="nom" id="editNom" required>
        <input name="prenom" id="editPrenom" required>
        <input name="email" id="editEmail">
        <input name="telephone" id="editTelephone">
        <input name="numero_permis" id="editPermis">

        <!-- Statut (editable) -->
        <label for="editStatut" style="margin-top:8px;display:block;">Statut</label>
        <select name="statut" id="editStatut">
          <option value="actif">Actif</option>
          <option value="inactif">Inactif</option>
          <option value="suspendu">Suspendu</option>
          <option value="en_conge">En congé</option>
        </select>

        <div class="modal-footer">
          <button type="button" onclick="closeModal('editDriverModal')">Cancel</button>
          <button type="submit" class="primary">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ================= DELETE MODAL ================= -->
  <div id="deleteDriverModal" class="modal">
    <div class="modal-content">
      <h2>Delete Driver</h2>
      <form id="deleteDriverForm" method="post" action="{% url 'dashboard_drivers' %}">
        {% csrf_token %}
        <input type="hidden" name="driver_id" id="deleteDriverId">
        <input type="hidden" name="action" value="delete">
        <p id="deleteDriverInfo">Are you sure?</p>

        <div class="modal-footer">
          <button type="button" onclick="closeModal('deleteDriverModal')">Cancel</button>
          <button type="submit" class="delete">Delete</button>
        </div>
      </form>
    </div>
  </div>

  {% endblock %}

  {% block extra_js %}
  <script src="{% static 'js/drivers.js' %}?v=3"></script>
  {% endblock %}
 
