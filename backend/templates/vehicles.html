{% extends 'base_dashboard.html' %}
{% load static %}

{% block title %}SwiftShip - Vehicles{% endblock %}

{% block nav_vehicles %}active{% endblock %}

{% block content %}
<h1 class="page-title"><i class="fas fa-truck"></i> Vehicles</h1>

<div class="table-section">
    <div class="table-header">
        <div class="table-search">
            <div class="table-search-input">
                <i class="fas fa-search"></i>
                <input type="text" id="vehicleSearch" placeholder="Search by plate number...">
            </div>
            <button class="filter-btn" id="filterBtn">
                <i class="fas fa-filter"></i>
                Filter
            </button>
        </div>
        
        <div class="table-toolbar">
            <button class="toolbar-btn add" onclick="openAddModal()">
                <i class="fas fa-plus"></i>
                Add Vehicle
            </button>
        </div>
    </div>

    <div class="table-container">
        <table class="data-table" id="vehiclesTable">
            <thead>
                <tr>
                    <th>Vehicle ID</th>
                    <th>Plate Number</th>
                    <th>Type</th>
                    <th>Capacity (kg)</th>
                    <th>Consumption</th>
                    <th>Status</th>
                    <th>Service Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="vehiclesTableBody">
                {% for vehicle in vehicles %}
                <tr data-id="{{ vehicle.id_vehicule }}" onclick="selectRow(this)">
                    <td>{{ vehicle.id_vehicule }}</td>
                    <td>{{ vehicle.immatriculation }}</td>
                    <td>{{ vehicle.type_vehicule|default:"-" }}</td>
                    <td>{{ vehicle.capacite_charge|default:"-" }}</td>
                    <td>{{ vehicle.consommation|default:"-" }} L/100km</td>
                    <td>
                        {% if vehicle.etat == 'disponible' %}
                        <span class="badge success">Available</span>
                        {% elif vehicle.etat == 'en_maintenance' %}
                        <span class="badge warning">Maintenance</span>
                        {% elif vehicle.etat == 'hors_service' %}
                        <span class="badge danger">Out of Service</span>
                        {% else %}
                        <span class="badge">{{ vehicle.etat }}</span>
                        {% endif %}
                    </td>
                    <td>{{ vehicle.date_mise_service|date:"Y-m-d"|default:"-" }}</td>
                    <td>
                        <div class="action-btns">
                            <button class="action-btn view" title="View" onclick="event.stopPropagation(); openViewModal('{{ vehicle.id_vehicule }}');">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn edit" title="Edit" onclick="event.stopPropagation(); openEditModal('{{ vehicle.id_vehicule }}');">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete" title="Delete" onclick="event.stopPropagation(); openDeleteModal('{{ vehicle.id_vehicule }}');">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="8" style="text-align:center;">No vehicles found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block modals %}
<!-- Add Modal -->
<div class="modal" id="addModal">
    <div class="modal-window edit-modal">
        <div class="modal-header">
            <h3><i class="fas fa-plus"></i> Add Vehicle</h3>
            <button class="modal-close" onclick="closeModal('addModal')"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <form class="modal-form" id="addVehicleForm">
                <div class="form-group">
                    <label>Plate Number</label>
                    <input type="text" id="addImmatriculation" placeholder="e.g., AB-123-CD" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Vehicle Type</label>
                        <select id="addType">
                            <option value="">Select type</option>
                            <option value="Van">Van</option>
                            <option value="Truck">Truck</option>
                            <option value="Motorcycle">Motorcycle</option>
                            <option value="Car">Car</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Capacity (kg)</label>
                        <input type="number" id="addCapacite" placeholder="Enter capacity" step="0.01">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Consumption (L/100km)</label>
                        <input type="number" id="addConsommation" placeholder="Enter consumption" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="addEtat">
                            <option value="disponible">Available</option>
                            <option value="en_maintenance">Maintenance</option>
                            <option value="hors_service">Out of Service</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Service Date</label>
                    <input type="date" id="addDateService">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="modal-btn cancel" onclick="closeModal('addModal')">Cancel</button>
            <button class="modal-btn primary" onclick="addVehicle()"><i class="fas fa-plus"></i> Add</button>
        </div>
    </div>
</div>

<!-- View Modal -->
<div class="modal" id="viewModal">
    <div class="modal-window view-modal">
        <div class="modal-header">
            <h3><i class="fas fa-eye"></i> Vehicle Details</h3>
            <button class="modal-close" onclick="closeModal('viewModal')"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <div id="viewVehicleDetails"></div>
        </div>
        <div class="modal-footer">
            <button class="modal-btn cancel" onclick="closeModal('viewModal')">Close</button>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal" id="editModal">
    <div class="modal-window edit-modal">
        <div class="modal-header">
            <h3><i class="fas fa-edit"></i> Edit Vehicle</h3>
            <button class="modal-close" onclick="closeModal('editModal')"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <form class="modal-form" id="editVehicleForm">
                <input type="hidden" id="editVehicleId">
                <div class="form-group">
                    <label>Plate Number</label>
                    <input type="text" id="editImmatriculation" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Vehicle Type</label>
                        <select id="editType">
                            <option value="">Select type</option>
                            <option value="Van">Van</option>
                            <option value="Truck">Truck</option>
                            <option value="Motorcycle">Motorcycle</option>
                            <option value="Car">Car</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Capacity (kg)</label>
                        <input type="number" id="editCapacite" step="0.01">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Consumption (L/100km)</label>
                        <input type="number" id="editConsommation" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="editEtat">
                            <option value="disponible">Available</option>
                            <option value="en_maintenance">Maintenance</option>
                            <option value="hors_service">Out of Service</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Service Date</label>
                    <input type="date" id="editDateService">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="modal-btn cancel" onclick="closeModal('editModal')">Cancel</button>
            <button class="modal-btn primary" onclick="saveVehicleChanges()"><i class="fas fa-save"></i> Save</button>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal" id="deleteModal">
    <div class="modal-window delete-modal">
        <div class="modal-header">
            <h3><i class="fas fa-trash"></i> Delete Vehicle</h3>
            <button class="modal-close" onclick="closeModal('deleteModal')"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <div class="delete-icon"><i class="fas fa-exclamation-triangle"></i></div>
            <p class="delete-message">Are you sure you want to delete this vehicle?</p>
            <p id="deleteVehicleInfo" style="font-weight:600;"></p>
            <p class="delete-warning">This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
            <button class="modal-btn cancel" onclick="closeModal('deleteModal')">Cancel</button>
            <button class="modal-btn danger" onclick="confirmDelete()"><i class="fas fa-trash"></i> Delete</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentVehicleId = null;
let selectedRow = null;

function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
           document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1] || '';
}

function selectRow(row) {
    if (selectedRow) selectedRow.classList.remove('selected');
    selectedRow = row;
    row.classList.add('selected');
}

function openAddModal() {
    document.getElementById('addVehicleForm').reset();
    document.getElementById('addModal').classList.add('active');
}

function openViewModal(vehicleId) {
    currentVehicleId = vehicleId;
    fetch(`/dashboard/vehicles/${vehicleId}/json/`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const v = data.vehicle;
                document.getElementById('viewVehicleDetails').innerHTML = `
                    <div class="detail-row"><strong>Vehicle ID:</strong> ${v.id_vehicule}</div>
                    <div class="detail-row"><strong>Plate:</strong> ${v.immatriculation}</div>
                    <div class="detail-row"><strong>Type:</strong> ${v.type_vehicule || '-'}</div>
                    <div class="detail-row"><strong>Capacity:</strong> ${v.capacite_charge ? v.capacite_charge + ' kg' : '-'}</div>
                    <div class="detail-row"><strong>Consumption:</strong> ${v.consommation ? v.consommation + ' L/100km' : '-'}</div>
                    <div class="detail-row"><strong>Status:</strong> ${v.etat || '-'}</div>
                    <div class="detail-row"><strong>Service Date:</strong> ${v.date_mise_service || '-'}</div>
                `;
                document.getElementById('viewModal').classList.add('active');
            }
        });
}

function openEditModal(vehicleId) {
    currentVehicleId = vehicleId;
    fetch(`/dashboard/vehicles/${vehicleId}/json/`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const v = data.vehicle;
                document.getElementById('editVehicleId').value = v.id_vehicule;
                document.getElementById('editImmatriculation').value = v.immatriculation || '';
                document.getElementById('editType').value = v.type_vehicule || '';
                document.getElementById('editCapacite').value = v.capacite_charge || '';
                document.getElementById('editConsommation').value = v.consommation || '';
                document.getElementById('editEtat').value = v.etat || 'disponible';
                document.getElementById('editDateService').value = v.date_mise_service || '';
                document.getElementById('editModal').classList.add('active');
            }
        });
}

function openDeleteModal(vehicleId) {
    currentVehicleId = vehicleId;
    document.getElementById('deleteVehicleInfo').textContent = `Vehicle ID: ${vehicleId}`;
    document.getElementById('deleteModal').classList.add('active');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
}

function addVehicle() {
    const data = {
        immatriculation: document.getElementById('addImmatriculation').value,
        type_vehicule: document.getElementById('addType').value,
        capacite_charge: document.getElementById('addCapacite').value,
        consommation: document.getElementById('addConsommation').value,
        etat: document.getElementById('addEtat').value,
        date_mise_service: document.getElementById('addDateService').value
    };
    fetch('/dashboard/vehicles/add/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
        body: JSON.stringify(data)
    }).then(r => r.json()).then(data => {
        if (data.success) { closeModal('addModal'); location.reload(); }
        else alert('Error: ' + (data.error || 'Failed'));
    });
}

function saveVehicleChanges() {
    const data = {
        immatriculation: document.getElementById('editImmatriculation').value,
        type_vehicule: document.getElementById('editType').value,
        capacite_charge: document.getElementById('editCapacite').value,
        consommation: document.getElementById('editConsommation').value,
        etat: document.getElementById('editEtat').value,
        date_mise_service: document.getElementById('editDateService').value
    };
    fetch(`/dashboard/vehicles/${currentVehicleId}/edit/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
        body: JSON.stringify(data)
    }).then(r => r.json()).then(data => {
        if (data.success) { closeModal('editModal'); location.reload(); }
        else alert('Error: ' + (data.error || 'Failed'));
    });
}

function confirmDelete() {
    fetch(`/dashboard/vehicles/${currentVehicleId}/delete/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': getCSRFToken() }
    }).then(r => r.json()).then(data => {
        if (data.success) { closeModal('deleteModal'); location.reload(); }
        else alert('Error: ' + (data.error || 'Failed'));
    });
}

document.getElementById('vehicleSearch').addEventListener('input', function(e) {
    const term = e.target.value.toLowerCase();
    document.querySelectorAll('#vehiclesTableBody tr').forEach(row => {
        row.style.display = row.textContent.toLowerCase().includes(term) ? '' : 'none';
    });
});
</script>
{% endblock %}
