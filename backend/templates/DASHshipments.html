{% extends 'base_dashboard.html' %}
{% load static %}

{% block title %}SwiftShip - Shipments{% endblock %}

{% block nav_shipments %}active{% endblock %}

{% block content %}
<h1 class="page-title"><i class="fas fa-box"></i> Shipments</h1>

<!-- Shipments Table Section -->
<div class="table-section">
    <!-- Table Header with Search -->
    <div class="table-header">
        <div class="table-search">
            <div class="table-search-input">
                <i class="fas fa-search"></i>
                <input type="text" id="shipmentSearch" placeholder="Search by client name...">
            </div>
            <button class="filter-btn" id="filterBtn">
                <i class="fas fa-filter"></i>
                Filter
            </button>
        </div>
        
        <div class="table-toolbar">
            <button class="toolbar-btn add" onclick="openAddModal()">
                <i class="fas fa-plus"></i>
                New Shipment
            </button>
        </div>
    </div>

    <!-- Data Table -->
    <div class="table-container">
        <table class="data-table" id="shipmentsTable">
            <thead>
                <tr>
                    <th>Shipment ID</th>
                    <th>Client</th>
                    <th>Origin</th>
                    <th>Destination</th>
                    <th>Status</th>
                    <th>Driver</th>
                    <th>Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="shipmentsTableBody">
                {% for shipment in shipments %}
                <tr data-id="{{ shipment.id_shipment }}" onclick="selectRow(this)">
                    <td>{{ shipment.id_shipment }}</td>
                    <td>{% if shipment.client %}{{ shipment.client.nom }} {{ shipment.client.prenom }}{% elif shipment.package.client %}{{ shipment.package.client.nom }} {{ shipment.package.client.prenom }}{% else %}-{% endif %}</td>
                    <td>{{ shipment.origin|default:"-" }}</td>
                    <td>{{ shipment.destination|default:"-" }}</td>
                    <td>
                        {% if shipment.statut == 'DELIVERED' %}
                        <span class="badge success">Delivered</span>
                        {% elif shipment.statut == 'IN_TRANSIT' %}
                        <span class="badge info">In Transit</span>
                        {% elif shipment.statut == 'PENDING' %}
                        <span class="badge warning">Pending</span>
                        {% else %}
                        <span class="badge">{{ shipment.statut }}</span>
                        {% endif %}
                    </td>
                    <td>{% if shipment.driver %}{{ shipment.driver.nom }} {{ shipment.driver.prenom }}{% else %}-{% endif %}</td>
                    <td>{{ shipment.shipment_date|date:"Y-m-d"|default:"-" }}</td>
                    <td>
                        <div class="action-btns">
                            <button class="action-btn view" title="View Details" onclick="event.stopPropagation(); openViewModal('{{ shipment.id_shipment }}');">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn edit" title="Modify" onclick="event.stopPropagation(); openEditModal('{{ shipment.id_shipment }}');">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete" title="Delete" onclick="event.stopPropagation(); openDeleteModal('{{ shipment.id_shipment }}');">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="8" style="text-align:center;">No shipments found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block modals %}
<!-- Add Modal -->
<div class="modal" id="addModal">
    <div class="modal-window edit-modal">
        <div class="modal-header">
            <h3><i class="fas fa-plus"></i> New Shipment</h3>
            <button class="modal-close" onclick="closeModal('addModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form class="modal-form" id="addShipmentForm">
                <div class="form-group">
                    <label for="addClient">Client</label>
                    <select id="addClient">
                        <option value="">Select a client</option>
                        {% for client in clients %}
                        <option value="{{ client.id_client }}">{{ client.nom }} {{ client.prenom }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="addOrigin">Origin</label>
                        <input type="text" id="addOrigin" placeholder="Enter origin">
                    </div>
                    <div class="form-group">
                        <label for="addDestination">Destination</label>
                        <input type="text" id="addDestination" placeholder="Enter destination">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="addStatus">Status</label>
                        <select id="addStatus">
                            <option value="PENDING">Pending</option>
                            <option value="IN_TRANSIT">In Transit</option>
                            <option value="DELIVERED">Delivered</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="addDriver">Driver</label>
                        <select id="addDriver">
                            <option value="">Select a driver</option>
                            {% for driver in drivers %}
                            <option value="{{ driver.id_chauffeur }}">{{ driver.nom }} {{ driver.prenom }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="addDate">Date</label>
                        <input type="date" id="addDate">
                    </div>
                    <div class="form-group">
                        <label for="addZone">Zone</label>
                        <select id="addZone">
                            <option value="NATIONAL">National</option>
                            <option value="INTERNATIONAL">International</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="addSpeed">Speed</label>
                        <select id="addSpeed">
                            <option value="NORMAL">Normal</option>
                            <option value="EXPRESS">Express</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="addDistance">Distance (km)</label>
                        <input type="number" id="addDistance" placeholder="Enter distance" step="0.01">
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="modal-btn cancel" onclick="closeModal('addModal')">Cancel</button>
            <button class="modal-btn primary" onclick="addShipment()">
                <i class="fas fa-plus"></i> Add
            </button>
        </div>
    </div>
</div>

<!-- View Modal -->
<div class="modal" id="viewModal">
    <div class="modal-window view-modal">
        <div class="modal-header">
            <h3><i class="fas fa-eye"></i> Shipment Details</h3>
            <button class="modal-close" onclick="closeModal('viewModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div id="viewShipmentDetails" class="shipment-details">
                <!-- Filled dynamically by JS -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="modal-btn cancel" onclick="closeModal('viewModal')">Close</button>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal" id="editModal">
    <div class="modal-window edit-modal">
        <div class="modal-header">
            <h3><i class="fas fa-edit"></i> Edit Shipment</h3>
            <button class="modal-close" onclick="closeModal('editModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form class="modal-form" id="editShipmentForm">
                <input type="hidden" id="editShipmentId">
                <div class="form-group">
                    <label for="editClient">Client</label>
                    <select id="editClient">
                        <option value="">Select a client</option>
                        {% for client in clients %}
                        <option value="{{ client.id_client }}">{{ client.nom }} {{ client.prenom }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editOrigin">Origin</label>
                        <input type="text" id="editOrigin" placeholder="Enter origin">
                    </div>
                    <div class="form-group">
                        <label for="editDestination">Destination</label>
                        <input type="text" id="editDestination" placeholder="Enter destination">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editStatus">Status</label>
                        <select id="editStatus">
                            <option value="PENDING">Pending</option>
                            <option value="IN_TRANSIT">In Transit</option>
                            <option value="DELIVERED">Delivered</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editDriver">Driver</label>
                        <select id="editDriver">
                            <option value="">Select a driver</option>
                            {% for driver in drivers %}
                            <option value="{{ driver.id_chauffeur }}">{{ driver.nom }} {{ driver.prenom }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editDate">Date</label>
                        <input type="date" id="editDate">
                    </div>
                    <div class="form-group">
                        <label for="editZone">Zone</label>
                        <select id="editZone">
                            <option value="NATIONAL">National</option>
                            <option value="INTERNATIONAL">International</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editSpeed">Speed</label>
                        <select id="editSpeed">
                            <option value="NORMAL">Normal</option>
                            <option value="EXPRESS">Express</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editDistance">Distance (km)</label>
                        <input type="number" id="editDistance" placeholder="Enter distance" step="0.01">
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="modal-btn cancel" onclick="closeModal('editModal')">Cancel</button>
            <button class="modal-btn primary" onclick="saveShipmentChanges()">
                <i class="fas fa-save"></i> Save Changes
            </button>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal" id="deleteModal">
    <div class="modal-window delete-modal">
        <div class="modal-header">
            <h3><i class="fas fa-trash"></i> Delete Shipment</h3>
            <button class="modal-close" onclick="closeModal('deleteModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="delete-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <p class="delete-message">Are you sure you want to delete this shipment?</p>
            <p id="deleteShipmentInfo" style="font-weight:600;"></p>
            <p class="delete-warning">This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
            <button class="modal-btn cancel" onclick="closeModal('deleteModal')">Cancel</button>
            <button class="modal-btn danger" onclick="confirmDelete()">
                <i class="fas fa-trash"></i> Delete
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Shipments CRUD functionality
let currentShipmentId = null;
let selectedRow = null;

// CSRF token helper
function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
           document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1] || '';
}

// Row selection
function selectRow(row) {
    if (selectedRow) {
        selectedRow.classList.remove('selected');
    }
    selectedRow = row;
    row.classList.add('selected');
}

// Modal functions
function openAddModal() {
    document.getElementById('addShipmentForm').reset();
    document.getElementById('addModal').classList.add('active');
}

function openViewModal(shipmentId) {
    currentShipmentId = shipmentId;
    fetch(`/dashboard/shipments/${shipmentId}/json/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const s = data.shipment;
                const statusBadge = getStatusBadge(s.status);
                document.getElementById('viewShipmentDetails').innerHTML = `
                    <div class="detail-row"><strong>Shipment ID:</strong> ${s.id_shipment}</div>
                    <div class="detail-row"><strong>Client:</strong> ${s.client || '-'}</div>
                    <div class="detail-row"><strong>Origin:</strong> ${s.origin || '-'}</div>
                    <div class="detail-row"><strong>Destination:</strong> ${s.destination || '-'}</div>
                    <div class="detail-row"><strong>Status:</strong> ${statusBadge}</div>
                    <div class="detail-row"><strong>Driver:</strong> ${s.driver || '-'}</div>
                    <div class="detail-row"><strong>Date:</strong> ${s.date || '-'}</div>
                    <div class="detail-row"><strong>Zone:</strong> ${s.zone || '-'}</div>
                    <div class="detail-row"><strong>Speed:</strong> ${s.speed || '-'}</div>
                    <div class="detail-row"><strong>Distance:</strong> ${s.distance ? s.distance + ' km' : '-'}</div>
                `;
                document.getElementById('viewModal').classList.add('active');
            }
        })
        .catch(err => console.error('Error fetching shipment:', err));
}

function openEditModal(shipmentId) {
    currentShipmentId = shipmentId;
    fetch(`/dashboard/shipments/${shipmentId}/json/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const s = data.shipment;
                document.getElementById('editShipmentId').value = s.id_shipment;
                document.getElementById('editClient').value = s.client_id || '';
                document.getElementById('editOrigin').value = s.origin || '';
                document.getElementById('editDestination').value = s.destination || '';
                document.getElementById('editStatus').value = s.status || 'PENDING';
                document.getElementById('editDriver').value = s.driver_id || '';
                document.getElementById('editDate').value = s.date || '';
                document.getElementById('editZone').value = s.zone || 'NATIONAL';
                document.getElementById('editSpeed').value = s.speed || 'NORMAL';
                document.getElementById('editDistance').value = s.distance || '';
                document.getElementById('editModal').classList.add('active');
            }
        })
        .catch(err => console.error('Error fetching shipment:', err));
}

function openDeleteModal(shipmentId) {
    currentShipmentId = shipmentId;
    document.getElementById('deleteShipmentInfo').textContent = `Shipment ID: ${shipmentId}`;
    document.getElementById('deleteModal').classList.add('active');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
}

// CRUD operations
function addShipment() {
    const payload = {
        client_id: document.getElementById('addClient').value,
        origin: document.getElementById('addOrigin').value,
        destination: document.getElementById('addDestination').value,
        status: document.getElementById('addStatus').value,
        driver_id: document.getElementById('addDriver').value,
        date: document.getElementById('addDate').value,
        zone: document.getElementById('addZone').value,
        speed: document.getElementById('addSpeed').value,
        distance: document.getElementById('addDistance').value || '0',
    };

    fetch('/dashboard/shipments/add/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(),
        },
        body: JSON.stringify(payload),
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeModal('addModal');
            location.reload();
        } else {
            alert('Error adding shipment: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(err => {
        console.error('Error:', err);
        alert('Error adding shipment');
    });
}

function saveShipmentChanges() {
    const shipmentId = document.getElementById('editShipmentId').value;
    const payload = {
        client_id: document.getElementById('editClient').value,
        origin: document.getElementById('editOrigin').value,
        destination: document.getElementById('editDestination').value,
        status: document.getElementById('editStatus').value,
        driver_id: document.getElementById('editDriver').value,
        date: document.getElementById('editDate').value,
        zone: document.getElementById('editZone').value,
        speed: document.getElementById('editSpeed').value,
        distance: document.getElementById('editDistance').value || '0',
    };

    fetch(`/dashboard/shipments/${shipmentId}/edit/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(),
        },
        body: JSON.stringify(payload),
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeModal('editModal');
            location.reload();
        } else {
            alert('Error updating shipment: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(err => {
        console.error('Error:', err);
        alert('Error updating shipment');
    });
}

function confirmDelete() {
    fetch(`/dashboard/shipments/${currentShipmentId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken(),
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeModal('deleteModal');
            location.reload();
        } else {
            alert('Error deleting shipment');
        }
    })
    .catch(err => {
        console.error('Error:', err);
        alert('Error deleting shipment');
    });
}

// Helper functions
function getStatusBadge(status) {
    const badges = {
        'DELIVERED': '<span class="badge success">Delivered</span>',
        'IN_TRANSIT': '<span class="badge info">In Transit</span>',
        'PENDING': '<span class="badge warning">Pending</span>',
    };
    return badges[status] || `<span class="badge">${status}</span>`;
}

// Search functionality
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('shipmentSearch');
    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#shipmentsTableBody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });
    }

    // Close modal when clicking outside
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.remove('active');
            }
        });
    });
});
</script>
{% endblock %}
