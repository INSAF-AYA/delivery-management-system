{% extends 'base_dashboard.html' %}
{% load static %}

{% block title %}SwiftShip - Agents{% endblock %}

{% block nav_agents %}active{% endblock %}

{% block content %}
<h1 class="page-title"><i class="fas fa-user-tie"></i> Agents</h1>

<div class="table-section">
    <div class="table-header">
        <div class="table-search">
            <div class="table-search-input">
                <i class="fas fa-search"></i>
                <input type="text" id="agentSearch" placeholder="Search agents...">
            </div>
            <button class="filter-btn" id="filterBtn">
                <i class="fas fa-filter"></i>
                Filter
            </button>
        </div>
        
        <div class="table-toolbar">
            <button class="toolbar-btn add" onclick="openAddModal()">
                <i class="fas fa-plus"></i>
                Add Agent
            </button>
        </div>
    </div>

    <div class="table-container">
        <table class="data-table" id="agentsTable">
            <thead>
                <tr>
                    <th>Agent ID</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Role</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="agentsTableBody">
                {% for agent in agents %}
                <tr data-id="{{ agent.agent_id }}" onclick="selectRow(this)">
                    <td>{{ agent.agent_id }}</td>
                    <td>{{ agent.nom }} {{ agent.prenom }}</td>
                    <td>{{ agent.email }}</td>
                    <td>{{ agent.telephone|default:"-" }}</td>
                    <td><span class="status-badge status-{{ agent.role|lower }}">{{ agent.role }}</span></td>
                    <td>
                        <div class="action-btns">
                            <button class="action-btn view" title="View" onclick="event.stopPropagation(); openViewModal('{{ agent.agent_id }}');">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn edit" title="Edit" onclick="event.stopPropagation(); openEditModal('{{ agent.agent_id }}');">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete" title="Delete" onclick="event.stopPropagation(); openDeleteModal('{{ agent.agent_id }}');">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" style="text-align:center;">No agents found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block modals %}
<!-- Add Modal -->
<div class="modal" id="addModal">
    <div class="modal-window edit-modal">
        <div class="modal-header">
            <h3><i class="fas fa-plus"></i> Add Agent</h3>
            <button class="modal-close" onclick="closeModal('addModal')"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <form class="modal-form" id="addAgentForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>First Name</label>
                        <input type="text" id="addPrenom" placeholder="First name" required>
                    </div>
                    <div class="form-group">
                        <label>Last Name</label>
                        <input type="text" id="addNom" placeholder="Last name" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="addEmail" placeholder="Email address" required>
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" id="addTelephone" placeholder="Phone number">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Role</label>
                        <select id="addRole" required>
                            <option value="Agent">Agent</option>
                            <option value="Admin">Admin</option>
                            <option value="Supervisor">Supervisor</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="addPassword" placeholder="Password" required>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="modal-btn cancel" onclick="closeModal('addModal')">Cancel</button>
            <button class="modal-btn primary" onclick="addAgent()"><i class="fas fa-plus"></i> Add</button>
        </div>
    </div>
</div>

<!-- View Modal -->
<div class="modal" id="viewModal">
    <div class="modal-window view-modal">
        <div class="modal-header">
            <h3><i class="fas fa-eye"></i> Agent Details</h3>
            <button class="modal-close" onclick="closeModal('viewModal')"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <div id="viewAgentDetails"></div>
        </div>
        <div class="modal-footer">
            <button class="modal-btn cancel" onclick="closeModal('viewModal')">Close</button>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal" id="editModal">
    <div class="modal-window edit-modal">
        <div class="modal-header">
            <h3><i class="fas fa-edit"></i> Edit Agent</h3>
            <button class="modal-close" onclick="closeModal('editModal')"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <form class="modal-form" id="editAgentForm">
                <input type="hidden" id="editAgentId">
                <div class="form-row">
                    <div class="form-group">
                        <label>First Name</label>
                        <input type="text" id="editPrenom" placeholder="First name" required>
                    </div>
                    <div class="form-group">
                        <label>Last Name</label>
                        <input type="text" id="editNom" placeholder="Last name" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="editEmail" placeholder="Email address" required>
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" id="editTelephone" placeholder="Phone number">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Role</label>
                        <select id="editRole" required>
                            <option value="Agent">Agent</option>
                            <option value="Admin">Admin</option>
                            <option value="Supervisor">Supervisor</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>New Password (optional)</label>
                        <input type="password" id="editPassword" placeholder="Leave blank to keep current">
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="modal-btn cancel" onclick="closeModal('editModal')">Cancel</button>
            <button class="modal-btn primary" onclick="saveAgent()"><i class="fas fa-save"></i> Save</button>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal" id="deleteModal">
    <div class="modal-window delete-modal">
        <div class="modal-header">
            <h3><i class="fas fa-trash"></i> Delete Agent</h3>
            <button class="modal-close" onclick="closeModal('deleteModal')"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <div class="delete-icon"><i class="fas fa-exclamation-triangle"></i></div>
            <p class="delete-message">Are you sure you want to delete this agent?</p>
            <p id="deleteAgentInfo" style="font-weight:600;"></p>
            <p class="delete-warning">This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
            <button class="modal-btn cancel" onclick="closeModal('deleteModal')">Cancel</button>
            <button class="modal-btn danger" onclick="confirmDelete()"><i class="fas fa-trash"></i> Delete</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentAgentId = null;
let selectedRow = null;

function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
           document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1] || '';
}

function selectRow(row) {
    if (selectedRow) selectedRow.classList.remove('selected');
    selectedRow = row;
    row.classList.add('selected');
}

function openAddModal() {
    document.getElementById('addAgentForm').reset();
    document.getElementById('addModal').classList.add('active');
}

function openViewModal(agentId) {
    currentAgentId = agentId;
    fetch(`/dashboard/agents/${agentId}/json/`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const agent = data.agent;
                document.getElementById('viewAgentDetails').innerHTML = `
                    <div class="detail-row"><strong>Agent ID:</strong> ${agent.agent_id}</div>
                    <div class="detail-row"><strong>Name:</strong> ${agent.nom} ${agent.prenom}</div>
                    <div class="detail-row"><strong>Email:</strong> ${agent.email}</div>
                    <div class="detail-row"><strong>Phone:</strong> ${agent.telephone || '-'}</div>
                    <div class="detail-row"><strong>Role:</strong> ${agent.role}</div>
                `;
                document.getElementById('viewModal').classList.add('active');
            }
        });
}

function openEditModal(agentId) {
    currentAgentId = agentId;
    fetch(`/dashboard/agents/${agentId}/json/`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const agent = data.agent;
                document.getElementById('editAgentId').value = agent.agent_id;
                document.getElementById('editPrenom').value = agent.prenom;
                document.getElementById('editNom').value = agent.nom;
                document.getElementById('editEmail').value = agent.email;
                document.getElementById('editTelephone').value = agent.telephone || '';
                document.getElementById('editRole').value = agent.role;
                document.getElementById('editPassword').value = '';
                document.getElementById('editModal').classList.add('active');
            }
        });
}

function openDeleteModal(agentId) {
    currentAgentId = agentId;
    document.getElementById('deleteAgentInfo').textContent = `Agent ID: ${agentId}`;
    document.getElementById('deleteModal').classList.add('active');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
}

function addAgent() {
    const data = {
        prenom: document.getElementById('addPrenom').value,
        nom: document.getElementById('addNom').value,
        email: document.getElementById('addEmail').value,
        telephone: document.getElementById('addTelephone').value,
        role: document.getElementById('addRole').value,
        password: document.getElementById('addPassword').value
    };
    fetch('/dashboard/agents/add/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
        body: JSON.stringify(data)
    }).then(r => r.json()).then(data => {
        if (data.success) { closeModal('addModal'); location.reload(); }
        else alert('Error: ' + (data.error || 'Failed'));
    });
}

function saveAgent() {
    const data = {
        prenom: document.getElementById('editPrenom').value,
        nom: document.getElementById('editNom').value,
        email: document.getElementById('editEmail').value,
        telephone: document.getElementById('editTelephone').value,
        role: document.getElementById('editRole').value
    };
    const password = document.getElementById('editPassword').value;
    if (password) data.password = password;
    
    fetch(`/dashboard/agents/${currentAgentId}/edit/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
        body: JSON.stringify(data)
    }).then(r => r.json()).then(data => {
        if (data.success) { closeModal('editModal'); location.reload(); }
        else alert('Error: ' + (data.error || 'Failed'));
    });
}

function confirmDelete() {
    fetch(`/dashboard/agents/${currentAgentId}/delete/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': getCSRFToken() }
    }).then(r => r.json()).then(data => {
        if (data.success) { closeModal('deleteModal'); location.reload(); }
        else alert('Error: ' + (data.error || 'Failed'));
    });
}

document.getElementById('agentSearch').addEventListener('input', function(e) {
    const term = e.target.value.toLowerCase();
    document.querySelectorAll('#agentsTableBody tr').forEach(row => {
        row.style.display = row.textContent.toLowerCase().includes(term) ? '' : 'none';
    });
});
</script>
{% endblock %}
