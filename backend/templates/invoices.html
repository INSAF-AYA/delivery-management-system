{% extends 'base_dashboard.html' %}
{% load static %}

{% block title %}SwiftShip - Invoices{% endblock %}

{% block nav_invoices %}active{% endblock %}

{% block content %}
<h1 class="page-title"><i class="fas fa-file-invoice-dollar"></i> Invoices</h1>

<div class="table-section">
    <div class="table-header">
        <div class="table-search">
            <div class="table-search-input">
                <i class="fas fa-search"></i>
                <input type="text" id="invoiceSearch" placeholder="Search invoices...">
            </div>
            <button class="filter-btn" id="filterBtn">
                <i class="fas fa-filter"></i>
                Filter
            </button>
        </div>

        <!-- Filter Panel -->
        <div id="filterPanel" style="display:none;margin-top:10px;" class="filter-panel">
            <label for="filterField" style="margin-right:8px;">Field:</label>
            <select id="filterField">
                <option value="all">All (Invoice ID / Client / Shipment / Amount / Date)</option>
                <option value="id">Invoice ID</option>
                <option value="client">Client</option>
                <option value="shipment">Shipment</option>
                <option value="amount">Amount</option>
                <option value="date">Date</option>
            </select>
            <input type="text" id="filterValue" placeholder="Filter value" style="margin-left:8px;" />
            <button class="modal-btn" id="applyFilterBtn" style="margin-left:8px;">Apply</button>
            <button class="modal-btn" id="clearFilterBtn" style="margin-left:6px;">Clear</button>
        </div>

                
        <div class="table-toolbar">
            <button class="toolbar-btn add" onclick="openAddModal()">
                <i class="fas fa-plus"></i>
                Create Invoice
            </button>
        </div>
    </div>

    <div class="table-container">
        <table class="data-table" id="invoicesTable">
            <thead>
                <tr>
                    <th>Invoice ID</th>
                    <th>Client</th>
                    <th>Shipment</th>
                    <th>Amount</th>
                    <th>Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="invoicesTableBody">
                {% for invoice in invoices %}
                <tr data-id="{{ invoice.id_invoice }}" onclick="selectRow(this)">
                    <td>{{ invoice.id_invoice }}</td>
                    <td>{{ invoice.client.nom }} {{ invoice.client.prenom }}</td>
                    <td>{{ invoice.shipment.id_shipment }}</td>
                    <td>${{ invoice.total_amount }}</td>
                    <td>{{ invoice.invoice_date|date:"Y-m-d" }}</td>
                    <td>
                        <div class="action-btns">
                            <button class="action-btn view" title="View" onclick="event.stopPropagation(); openViewModal('{{ invoice.id_invoice }}');">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn edit" title="Download" onclick="event.stopPropagation(); downloadInvoice('{{ invoice.id_invoice }}');">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="action-btn delete" title="Delete" onclick="event.stopPropagation(); openDeleteModal('{{ invoice.id_invoice }}');">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" style="text-align:center;">No invoices found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block modals %}
<!-- Add Modal -->
<div class="modal" id="addModal">
    <div class="modal-window edit-modal">
        <div class="modal-header">
            <h3><i class="fas fa-plus"></i> Create Invoice</h3>
            <button class="modal-close" onclick="closeModal('addModal')"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <form class="modal-form" id="addInvoiceForm">
                <div class="form-group">
                    <label>Client</label>
                    <select id="addClient" required>
                        <option value="">Select client</option>
                        {% for client in clients %}
                        <option value="{{ client.id_client }}">{{ client.nom }} {{ client.prenom }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Shipment</label>
                    <select id="addShipment" required>
                        <option value="">Select shipment</option>
                        {% for shipment in shipments %}
                        <option value="{{ shipment.id_shipment }}">{{ shipment.id_shipment }} - {{ shipment.destination }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-row"> 
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="addDate" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Total Amount</label>
                    <div class="form-control bg-light">
                        <span id="totalAmount">—</span>
                    </div>
                    <input type="hidden" id="addAmount" name="total_amount">
                </div>
                <div class="form-group">
                    <label>Upload PDF</label>
                    <input type="file" id="addPDF" accept="application/pdf" required>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="modal-btn cancel" onclick="closeModal('addModal')">Cancel</button>
            <button class="modal-btn primary" onclick="addInvoice()"><i class="fas fa-plus"></i> Create</button>
        </div>
    </div>
</div>

<!-- View Modal -->
<div class="modal" id="viewModal">
    <div class="modal-window view-modal">
        <div class="modal-header">
            <h3><i class="fas fa-eye"></i> Invoice Details</h3>
            <button class="modal-close" onclick="closeModal('viewModal')"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <div id="viewInvoiceDetails"></div>
        </div>
        <div class="modal-footer">
            <button class="modal-btn cancel" onclick="closeModal('viewModal')">Close</button>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal" id="deleteModal">
    <div class="modal-window delete-modal">
        <div class="modal-header">
            <h3><i class="fas fa-trash"></i> Delete Invoice</h3>
            <button class="modal-close" onclick="closeModal('deleteModal')"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <div class="delete-icon"><i class="fas fa-exclamation-triangle"></i></div>
            <p class="delete-message">Are you sure you want to delete this invoice?</p>
            <p id="deleteInvoiceInfo" style="font-weight:600;"></p>
            <p class="delete-warning">This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
            <button class="modal-btn cancel" onclick="closeModal('deleteModal')">Cancel</button>
            <button class="modal-btn danger" onclick="confirmDelete()"><i class="fas fa-trash"></i> Delete</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentInvoiceId = null;
let selectedRow = null;

function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
           document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1] || '';
}

function selectRow(row) {
    if (selectedRow) selectedRow.classList.remove('selected');
    selectedRow = row;
    row.classList.add('selected');
}

function openAddModal() {
    document.getElementById('addInvoiceForm').reset();
    document.getElementById('addDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('addModal').classList.add('active');
}

function openViewModal(invoiceId) {
    currentInvoiceId = invoiceId;
    fetch(`/dashboard/invoices/${invoiceId}/json/`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const inv = data.invoice;
                document.getElementById('viewInvoiceDetails').innerHTML = `
                    <div class="detail-row"><strong>Invoice ID:</strong> ${inv.id_invoice}</div>
                    <div class="detail-row"><strong>Client:</strong> ${inv.client || '-'}</div>
                    <div class="detail-row"><strong>Shipment:</strong> ${inv.shipment || '-'}</div>
                    <div class="detail-row"><strong>Amount:</strong> $${inv.total_amount}</div>
                    <div class="detail-row"><strong>Date:</strong> ${inv.invoice_date || '-'}</div>
                `;
                document.getElementById('viewModal').classList.add('active');
            }
        });
}

function openDeleteModal(invoiceId) {
    currentInvoiceId = invoiceId;
    document.getElementById('deleteInvoiceInfo').textContent = `Invoice ID: ${invoiceId}`;
    document.getElementById('deleteModal').classList.add('active');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
}

function addInvoice() {
    const formData = new FormData();
    formData.append('client_id', document.getElementById('addClient').value);
    formData.append('shipment_id', document.getElementById('addShipment').value);
    formData.append('total_amount', document.getElementById('addAmount').value);
    formData.append('invoice_date', document.getElementById('addDate').value);
    formData.append('invoice_pdf', document.getElementById('addPDF').files[0]);

    fetch('/dashboard/invoices/add/', {
        method: 'POST',
        headers: { 'X-CSRFToken': getCSRFToken() },
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) { closeModal('addModal'); location.reload(); }
        else alert('Error: ' + (data.error || 'Failed'));
    });
}


function downloadInvoice(invoiceId) {
    window.open(`/dashboard/invoices/${invoiceId}/download/`, '_blank');
}

function confirmDelete() {
    fetch(`/dashboard/invoices/${currentInvoiceId}/delete/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': getCSRFToken() }
    }).then(r => r.json()).then(data => {
        if (data.success) { closeModal('deleteModal'); location.reload(); }
        else alert('Error: ' + (data.error || 'Failed'));
    });
}

document.getElementById('invoiceSearch').addEventListener('input', function(e) {
    const term = e.target.value.toLowerCase();
    document.querySelectorAll('#invoicesTableBody tr').forEach(row => {
        row.style.display = row.textContent.toLowerCase().includes(term) ? '' : 'none';
    });
});

function getShipmentAmountsUrl(shipmentId) {
    return "{% url 'invoice:shipment_amounts' 'SHIPMENT_ID' %}".replace('SHIPMENT_ID', shipmentId);
}

document.getElementById('addShipment').addEventListener('change', function() {
    const shipmentId = this.value;
    if (!shipmentId) {
        document.getElementById('totalAmount').innerText = '—';
        document.getElementById('addAmount').value = '';
        return;
    }

    fetch(getShipmentAmountsUrl(shipmentId))
        .then(res => res.json())
        .then(data => {
            document.getElementById('totalAmount').innerText =
                `HT: ${data.montant_ht} | TVA: ${data.montant_tva} | TTC: ${data.montant_ttc}`;
            document.getElementById('addAmount').value = data.montant_ttc;
        })
        .catch(err => {
            console.error(err);
            document.getElementById('totalAmount').innerText = 'Error';
            document.getElementById('addAmount').value = '';
        });
});

// Initialize search + filter controls
document.addEventListener('DOMContentLoaded', function () {
    const searchInput = document.getElementById('invoiceSearch');
    if (searchInput) {
        searchInput.addEventListener('input', e => {
            filterInvoices('all', e.target.value);
        });
    }

    const filterBtn = document.getElementById('filterBtn');
    if (filterBtn) filterBtn.addEventListener('click', () => toggleFilterPanel());

    const applyFilterBtn = document.getElementById('applyFilterBtn');
    if (applyFilterBtn) applyFilterBtn.addEventListener('click', () => applyFilter());
    const clearFilterBtn = document.getElementById('clearFilterBtn');
    if (clearFilterBtn) clearFilterBtn.addEventListener('click', () => clearFilter());
});

function filterInvoices(fieldOrTerm, maybeTerm) {
    let field = 'all';
    let term = '';
    if (typeof maybeTerm === 'undefined') {
        term = (fieldOrTerm || '').toString().toLowerCase();
    } else {
        field = (fieldOrTerm || 'all').toString();
        term = (maybeTerm || '').toString().toLowerCase();
    }

    const rows = document.querySelectorAll('#invoicesTableBody tr');
    const map = {
        id: 0,
        client: 1,
        shipment: 2,
        amount: 3,
        date: 4
    };

    rows.forEach(row => {
        if (!term) { row.style.display = ''; return; }

        if (field === 'all') {
            const id = (row.cells[0]?.textContent || '').toLowerCase();
            const client = (row.cells[1]?.textContent || '').toLowerCase();
            const shipment = (row.cells[2]?.textContent || '').toLowerCase();
            const amount = (row.cells[3]?.textContent || '').toLowerCase();
            const date = (row.cells[4]?.textContent || '').toLowerCase();
            const hay = `${id} ${client} ${shipment} ${amount} ${date}`;
            row.style.display = hay.includes(term) ? '' : 'none';
        } else {
            const idx = map[field];
            const value = (row.cells[idx]?.textContent || '').toLowerCase();
            row.style.display = value.includes(term) ? '' : 'none';
        }
    });
}

function toggleFilterPanel() {
    const panel = document.getElementById('filterPanel');
    if (!panel) return;
    panel.style.display = (panel.style.display === 'none' || panel.style.display === '') ? 'block' : 'none';
}

function applyFilter() {
    const field = document.getElementById('filterField')?.value || 'all';
    const value = document.getElementById('filterValue')?.value || '';
    filterInvoices(field, value.trim());
}

function clearFilter() {
    const fieldEl = document.getElementById('filterField');
    const valEl = document.getElementById('filterValue');
    if (fieldEl) fieldEl.value = 'all';
    if (valEl) valEl.value = '';
    const searchInput = document.getElementById('invoiceSearch');
    if (searchInput) searchInput.value = '';
    filterInvoices('all', '');
}

</script>
{% endblock %}

